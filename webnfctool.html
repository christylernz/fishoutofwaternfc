<!DOCTYPE html>
<html>

<head>
    <title>Fish Out Of Water NFC</title>
    <link rel="stylesheet" href="https://christylernz.github.io/fishoutofwaternfc/css/bootstrap.min.css">

</head>

<body>
    <p class="ml-2 mt-2">
        <button class="btn btn-lg btn-default" onclick="readNfc()">Test NFC Read</button>
        <button class="btn btn-lg btn-default" onclick="writeNfc()">Test NFC Write</button>
    </p>

    <pre id="log"></pre>
    <p id="version">Build 15</p>
    <script>
        function writeNfc() {
            if ('nfc' in navigator) {
                consoleLog("Sending to NFC.");
                try {
                    navigator.nfc.push({
                        url: "/custom/path",
                        records: [{
                            recordType: "string",
                            data: 'Hello World'
                        }]
                    });
                } catch (err) {
                    consoleLog("Error: " + JSON.stringify(err));
                }
                consoleLog("Hello World sent via NFC.");
            } else {
                consoleLog('NFC API not supported.');
            }
        }

        function readNfc() {
            if ('nfc' in navigator) {
                navigator.nfc.watch(function(message) {
                        consoleLog("NFC message received from URL " + message.url);
                        if (message.data[0].recordType === 'empty') {
                            consoleLog("NFC Message is empty.")
                        }
                        processMessage(message);
                    }, {
                        mode: "any"
                    })
                    .then(() => consoleLog("Added a watch."))
                    .catch(err => consoleLog("Adding watch failed: " + err.name));
            } else {
                consoleLog('NFC API not supported.');
            }
        }

        function consoleLog(data) {
            var logElement = document.getElementById('log');
            logElement.innerHTML += '\n' + data;
        }

        function processMessage(message) {
            consoleLog("Message contains content");
            message.data.forEach(function(record) {
                if (record.recordType == "string") {
                    consoleLog('Data is string: ' + record.data);
                } else if (record.recordType == "json") {
                    processJSON(record.data);
                } else if (record.recordType == "url") {
                    consoleLog("Data is URL: " + record.data);
                } else if (record.recordType == "opaque" && record.mediaType == 'image/png') {
                    processPng(record.data);
                } else {
                    consoleLog("Unable to determine content");
                };
            });
        }

        function processPng(data) {
            consoleLog("Known image/png data");

            var img = document.createElement("img");
            img.src = URL.createObjectURL(new Blob(data, 'image/png'));
            img.onload = function() {
                window.URL.revokeObjectURL(this.src);
            };
        };

        function processJSON(data) {
            var obj = JSON.parse(data);
            consoleLog("JSON data: " + obj.myProperty.toString());
        };

    </script>
</body>

</html>
